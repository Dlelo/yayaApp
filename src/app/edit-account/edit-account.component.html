@if(userDetails$ | async; as userDetails){
  <div class="container my-4">
    <mat-card class="shadow-sm rounded-3 p-4">
      <div class="d-flex align-items-center mb-4">
        <mat-icon class="me-2 text-primary">edit</mat-icon>
        <h2>Update {{userDetails.name}} account details</h2>
      </div>

      @if(form){
        <form [formGroup]="form" class="row g-3">

          <!-- UPLOAD SECTION -->
          <div class="upload-section mb-4">
            <h4 class="section-title mb-3">Documents & Photo</h4>

            <div class="row g-3">
              <!-- Profile Picture Upload -->
              <div class="col-md-6">
                <div class="upload-card">
                  <label class="upload-label">Profile Picture</label>

                  <div class="preview-window">
                    @if(profilePicturePreviewUrl){
                      <img [src]="profilePicturePreviewUrl" alt="Profile" class="preview-image profile-preview" />
                      <button
                        mat-icon-button
                        class="delete-btn"
                        type="button"
                        (click)="profilePictureFile=null; profilePicturePreviewUrl=null">
                        <mat-icon>close</mat-icon>
                      </button>
                    } @else {
                      <div class="placeholder">
                        <mat-icon>account_circle</mat-icon>
                        <span>No image</span>
                      </div>
                    }
                  </div>

                  <div class="upload-actions">
                    <label mat-stroked-button class="upload-btn">
                      <mat-icon>upload</mat-icon>
                      Choose File
                      <input
                        type="file"
                        hidden
                        accept="image/jpeg,image/jpg"
                        (change)="onProfilePictureSelected($event)"
                      />
                    </label>

                    @if(profilePicturePreviewUrl){
                      <button
                        mat-flat-button
                        color="primary"
                        type="button"
                        class="upload-submit-btn"
                        (click)="uploadProfilePicture(userDetails?.houseHelp?.id || userDetails?.homeOwner?.id)">
                        Upload
                      </button>
                    }
                  </div>

                  @if(profileUploadProgress > 0 && profileUploadProgress < 100){
                    <mat-progress-bar
                      mode="determinate"
                      [value]="profileUploadProgress"
                      class="mt-2">
                    </mat-progress-bar>
                  }
                </div>
              </div>

              <!-- National ID Upload -->
              <div class="col-md-6">
                <div class="upload-card">
                  <label class="upload-label">National ID</label>

                  <div class="preview-window">
                    @if(nationalIdPreviewUrl){
                      <img [src]="nationalIdPreviewUrl" alt="National ID" class="preview-image" />
                      <button
                        mat-icon-button
                        class="delete-btn"
                        type="button"
                        (click)="nationalIdFile=null; nationalIdPreviewUrl=null">
                        <mat-icon>close</mat-icon>
                      </button>
                    } @else if(nationalIdFileName){
                      <div class="file-preview">
                        <mat-icon>description</mat-icon>
                        <span class="file-name">{{ nationalIdFileName }}</span>
                      </div>
                      <button
                        mat-icon-button
                        class="delete-btn"
                        type="button"
                        (click)="nationalIdFile=null; nationalIdFileName=null">
                        <mat-icon>close</mat-icon>
                      </button>
                    } @else {
                      <div class="placeholder">
                        <mat-icon>badge</mat-icon>
                        <span>No document</span>
                      </div>
                    }
                  </div>

                  <div class="upload-actions">
                    <label mat-stroked-button class="upload-btn">
                      <mat-icon>upload</mat-icon>
                      Choose File
                      <input
                        type="file"
                        hidden
                        accept="application/pdf"
                        (change)="onFileSelected($event)"
                      />
                    </label>

                    @if(nationalIdPreviewUrl || nationalIdFileName){
                      @if(isHouseHelp){
                        <button
                          mat-flat-button
                          color="primary"
                          type="button"
                          class="upload-submit-btn"
                          (click)="uploadNationalId(userDetails?.houseHelp?.id)">
                          Upload
                        </button>
                      }
                      @if(isHomeOwner){
                        <button
                          mat-flat-button
                          color="primary"
                          type="button"
                          class="upload-submit-btn"
                          (click)="uploadNationalId(userDetails?.homeOwner?.id)">
                          Upload
                        </button>
                      }
                    }
                  </div>

                  @if(uploadProgress > 0 && uploadProgress < 100){
                    <mat-progress-bar
                      mode="determinate"
                      [value]="uploadProgress"
                      class="mt-2">
                    </mat-progress-bar>
                  }
                </div>
              </div>
            </div>
<!--            <div class="col-md-12 mt-3">-->
<!--              <label class="form-label">Pick Your Location</label>-->
<!--              <div id="map" style="height: 400px; border: 1px solid #ccc; border-radius: 8px;"></div>-->
<!--            </div>-->
          </div>

          <!-- HOUSEHELP fields -->
          @if(isHouseHelp){
            <div formGroupName="houseHelp">
              <h4 class="section-title mb-3">Personal Information</h4>

              <div class="row g-3">
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>National ID</mat-label>
                    <input matInput formControlName="nationalId" />
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Availability Type</mat-label>
                    <mat-select formControlName="houseHelpType">
                      @for(type of availabilityTypes; track $index){
                        <mat-option [value]="type">
                          {{ type.replace('_', ' ') }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Age</mat-label>
                    <input matInput formControlName="age" type="number" />
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Religion</mat-label>
                    <input matInput formControlName="religion" />
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Number of Children</mat-label>
                    <input matInput formControlName="numberOfChildren" type="number" />
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Level of Education</mat-label>
                    <input matInput formControlName="levelOfEducation" />
                  </mat-form-field>
                </div>
              </div>

              <h4 class="section-title mb-3 mt-4">Professional Details</h4>

              <div class="row g-3">
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Skills</mat-label>

                    <mat-chip-grid #skillsGrid>
                      @for(skill of skills; track skill){
                        <mat-chip-row (removed)="removeChip(skill, 'skills')">
                          {{ skill }}
                          <button matChipRemove>
                            <mat-icon>cancel</mat-icon>
                          </button>
                        </mat-chip-row>
                      }

                      <input
                        placeholder="Add skill"
                        [matChipInputFor]="skillsGrid"
                        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                        (matChipInputTokenEnd)="addChip($event, 'skills')" />
                    </mat-chip-grid>
                  </mat-form-field>
                </div>


                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Years of Experience</mat-label>
                    <input matInput type="number" formControlName="yearsOfExperience" />
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Available</mat-label>
                    <input matInput formControlName="availability" />
                  </mat-form-field>
                </div>


                <div class="col-md-12">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Experience summary</mat-label>
                    <textarea matInput formControlName="experienceSummary">

                    </textarea>
                  </mat-form-field>
                </div>


                <div class="col-md-12">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Languages</mat-label>

                    <mat-chip-grid #languagesGrid>
                      @for(lang of languages; track lang){
                        <mat-chip-row (removed)="removeChip(lang, 'languages')">
                          {{ lang }}
                          <button matChipRemove>
                            <mat-icon>cancel</mat-icon>
                          </button>
                        </mat-chip-row>
                      }

                      <input
                        placeholder="Add language"
                        [matChipInputFor]="languagesGrid"
                        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                        (matChipInputTokenEnd)="addChip($event, 'languages')" />
                    </mat-chip-grid>
                  </mat-form-field>
                </div>

              </div>

              <h4 class="section-title mb-3 mt-4">Location & Physical Details</h4>

              <div class="row g-3">

                @if(isHouseHelp){
                  <div class="col-md-6">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Current County</mat-label>
                      <input matInput formControlName="currentCounty" />
                    </mat-form-field>
                  </div>

                  <div class="col-md-6">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Home County</mat-label>
                      <input matInput formControlName="homeCounty" />
                    </mat-form-field>
                  </div>
                }


                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Current Location</mat-label>
                    <input matInput formControlName="currentLocation" />
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Home Location</mat-label>
                    <input matInput formControlName="homeLocation" />
                  </mat-form-field>
                </div>

                <div class="col-md-4">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Height (cm)</mat-label>
                    <input matInput formControlName="height" type="number" />
                  </mat-form-field>
                </div>

                <div class="col-md-4">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Weight (kg)</mat-label>
                    <input matInput formControlName="weight" type="number" />
                  </mat-form-field>
                </div>
              </div>

              <h4 class="section-title mb-3 mt-4">Emergency Contact</h4>

              <div class="row g-3">
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Contact Person Name</mat-label>
                    <input matInput formControlName="contactPersons" />
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Contact Person Phone</mat-label>
                    <input matInput formControlName="contactPersonsPhoneNumber" />
                  </mat-form-field>
                </div>
              </div>

              <h4 class="section-title mb-3 mt-4">Preferences</h4>

              <div formGroupName="preferences" class="row g-3">
                <!-- Min Experience -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Minimum Experience (years)</mat-label>
                    <input matInput type="number" formControlName="minExperience"/>
                  </mat-form-field>
                </div>

                <!-- Preferred Location -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Location</mat-label>
                    <input matInput formControlName="preferredLocation"/>
                  </mat-form-field>
                </div>

                <!-- Preferred Skills Chips -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Skills</mat-label>
                    <mat-chip-grid #prefSkillsGrid>
                      <mat-chip-row *ngFor="let skill of form.get('houseHelp.preferences.preferredSkills')?.value"
                                    (removed)="removeChip(skill, 'preferredSkills')">
                        {{ skill }}
                        <button matChipRemove><mat-icon>cancel</mat-icon></button>
                      </mat-chip-row>

                      <input placeholder="Add skill"
                             [matChipInputFor]="prefSkillsGrid"
                             [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                             (matChipInputTokenEnd)="addChip($event, 'preferredSkills', 'houseHelp')"/>
                    </mat-chip-grid>
                  </mat-form-field>
                </div>

                <!-- Preferred Languages Chips -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Languages</mat-label>
                    <mat-chip-grid #prefLanguagesGrid>
                      <mat-chip-row *ngFor="let lang of form.get('houseHelp.preferences.preferredLanguages')?.value"
                                    (removed)="removeChip(lang, 'preferredLanguages')">
                        {{ lang }}
                        <button matChipRemove><mat-icon>cancel</mat-icon></button>
                      </mat-chip-row>

                      <input placeholder="Add language"
                             [matChipInputFor]="prefLanguagesGrid"
                             [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                             (matChipInputTokenEnd)="addChip($event, 'preferredLanguages', 'houseHelp')"/>
                    </mat-chip-grid>
                  </mat-form-field>
                </div>

                <!-- Preferred Child Age Ranges (comma separated for simplicity) -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Child Age Ranges (comma separated)</mat-label>
                    <input matInput formControlName="preferredChildAgeRanges"/>
                  </mat-form-field>
                </div>

                <!-- Preferred Max Children -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Maximum Children</mat-label>
                    <input matInput type="number" formControlName="preferredMaxChildren"/>
                  </mat-form-field>
                </div>

                <!-- Preferred Services (comma separated) -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Services</mat-label>
                    <input matInput formControlName="preferredServices"/>
                  </mat-form-field>
                </div>

                <!-- Preferred Religion -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Religion</mat-label>
                    <input matInput formControlName="preferredReligion"/>
                  </mat-form-field>
                </div>

                <!-- Okay With Pets -->
                <div class="col-md-6 d-flex align-items-center mt-2">
                  <mat-checkbox formControlName="okayWithPets">Okay with Pets</mat-checkbox>
                </div>

                <!-- Min & Max Salary -->
                <div class="col-md-3">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Minimum Salary (KSh)</mat-label>
                    <input matInput type="number" formControlName="minSalary"/>
                  </mat-form-field>
                </div>

                <div class="col-md-3">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Maximum Salary (KSh)</mat-label>
                    <input matInput type="number" formControlName="maxSalary"/>
                  </mat-form-field>
                </div>
              </div>

            </div>
          }

          <!-- HOMEOWNER fields -->
          @if(isHomeOwner){
            <div formGroupName="homeOwner">
              <h4 class="section-title mb-3">Personal Information</h4>

              <div class="row g-3">
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>National ID</mat-label>
                    <input matInput formControlName="nationalId" />
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Number of Dependents</mat-label>
                    <input matInput formControlName="numberOfDependents" type="number" />
                  </mat-form-field>
                </div>
              </div>

              <h4 class="section-title mb-3 mt-4">Property Details</h4>

              <div class="row g-3">
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>House Type</mat-label>
                    <mat-select formControlName="houseType">
                      <mat-option value="apartment">Apartment</mat-option>
                      <mat-option value="bungalow">Bungalow</mat-option>
                      <mat-option value="mansionette">Mansionette</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Number of Bedrooms</mat-label>
                    <input matInput formControlName="numberOfRooms" type="number" />
                  </mat-form-field>
                </div>

                <div class="col-md-12">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Location</mat-label>
                    <input matInput formControlName="homeLocation"/>
                  </mat-form-field>
                </div>
              </div>

              <h4 class="section-title mb-3 mt-4">Preferences</h4>

              <div formGroupName="preferences" class="row g-3">

                <!-- Preferred Location -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Location</mat-label>
                    <input matInput formControlName="preferredLocation"/>
                  </mat-form-field>
                </div>

                <!-- Preferred Skills Chips -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Skills</mat-label>
                    <mat-chip-grid #hoPrefSkillsGrid>
                      <mat-chip-row *ngFor="let skill of form.get('homeOwner.preferences.preferredSkills')?.value"
                                    (removed)="removeChip(skill, 'preferredSkills', 'homeOwner')">
                        {{ skill }}
                        <button matChipRemove><mat-icon>cancel</mat-icon></button>
                      </mat-chip-row>

                      <input placeholder="Add skill"
                             [matChipInputFor]="hoPrefSkillsGrid"
                             [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                             (matChipInputTokenEnd)="addChip($event, 'preferredSkills', 'homeOwner')"/>
                    </mat-chip-grid>
                  </mat-form-field>
                </div>

                <!-- Preferred Languages Chips -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Languages</mat-label>
                    <mat-chip-grid #hoPrefLanguagesGrid>
                      <mat-chip-row *ngFor="let lang of form.get('homeOwner.preferences.preferredLanguages')?.value"
                                    (removed)="removeChip(lang, 'preferredLanguages', 'homeOwner')">
                        {{ lang }}
                        <button matChipRemove><mat-icon>cancel</mat-icon></button>
                      </mat-chip-row>

                      <input placeholder="Add language"
                             [matChipInputFor]="hoPrefLanguagesGrid"
                             [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                             (matChipInputTokenEnd)="addChip($event, 'preferredLanguages', 'homeOwner')"/>
                    </mat-chip-grid>
                  </mat-form-field>
                </div>

                <!-- Preferred Child Age Ranges -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Child Age Ranges (comma separated)</mat-label>
                    <input matInput formControlName="preferredChildAgeRanges"/>
                  </mat-form-field>
                </div>

                <!-- Preferred Max Children -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Maximum Children</mat-label>
                    <input matInput type="number" formControlName="preferredMaxChildren"/>
                  </mat-form-field>
                </div>

                <!-- Preferred Services -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Services (comma separated)</mat-label>
                    <input matInput formControlName="preferredServices"/>
                  </mat-form-field>
                </div>

                <!-- Preferred Religion -->
                <div class="col-md-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Preferred Religion</mat-label>
                    <input matInput formControlName="preferredReligion"/>
                  </mat-form-field>
                </div>

                <!-- Okay With Pets -->
                <div class="col-md-6 d-flex align-items-center mt-2">
                  <mat-checkbox formControlName="okayWithPets"> Okay with Pets</mat-checkbox>
                </div>

                <!-- Min & Max Salary -->
                <div class="col-md-3">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Minimum Salary (KSh)</mat-label>
                    <input matInput type="number" formControlName="minSalary"/>
                  </mat-form-field>
                </div>

                <div class="col-md-3">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Maximum Salary (KSh)</mat-label>
                    <input matInput type="number" formControlName="maxSalary"/>
                  </mat-form-field>
                </div>
              </div>

            </div>
          }

          <div class="d-flex justify-content-end mt-4 gap-2">
            <button mat-stroked-button color="warn" type="button" (click)="cancel()">Cancel</button>
            @if(isHouseHelp) {
              <button mat-flat-button color="primary" type="submit" (click)="save(userDetails?.houseHelp?.id)">
                Save Changes
              </button>
            }
            @if(isHomeOwner) {
              <button mat-flat-button color="primary" type="submit" (click)="save(userDetails?.homeOwner?.id)">
                Save Changes
              </button>
            }
          </div>
        </form>
      }
    </mat-card>
  </div>
}
