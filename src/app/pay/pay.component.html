<div class="container my-4">
  <mat-card class="p-4 shadow-sm">
    <h2 class="mb-3 text-center">Complete Payment to Hire</h2>

    @if (isProcessing) {
      <div class="text-center my-4">
        <mat-spinner diameter="50" class="mx-auto mb-3"></mat-spinner>
        <p class="text-muted">Processing payment... Check your phone for M-Pesa prompt</p>
      </div>
    }
    @else if (isManualPayment) {

      <div>
        <mat-card class="instructions-card mb-4">
          <mat-card-content>
            <h4 class="text-success text-center mb-3">Manual Payment</h4>
            <h5 class="text-success mb-3">(Automation of this process coming soon!)</h5>
            <h5 class="mb-3">
              <mat-icon class="align-middle me-2 text-success">phone_android</mat-icon>
              How to Pay via M-Pesa
            </h5>
            
            <ol class="payment-steps">
              <li>
                <mat-icon class="step-icon">looks_one</mat-icon>
                <span>Go to M-Pesa menu on your phone</span>
              </li>
              <li>
                <mat-icon class="step-icon">looks_two</mat-icon>
                <span>Select <strong>Lipa na M-Pesa</strong></span>
              </li>
              <li>
                <mat-icon class="step-icon">looks_3</mat-icon>
                <span>Select <strong>Pay Bill</strong></span>
              </li>
              <li>
                <mat-icon class="step-icon">looks_4</mat-icon>
                <span>Enter Business Number: <strong>{{ paybillNumber }}</strong></span>
              </li>
              <li>
                <mat-icon class="step-icon">looks_5</mat-icon>
                <span>Enter Account Number: <strong>{{ accountNumber }}</strong></span>
              </li>
              <li>
                <mat-icon class="step-icon">looks_6</mat-icon>
                <span>Enter Amount: <strong>KES {{ getTotalAmount() | number }}</strong></span>
              </li>
              <li>
                <mat-icon class="step-icon">check_circle</mat-icon>
                <span>Enter your M-Pesa PIN and confirm</span>
              </li>
            </ol>
          </mat-card-content>
        </mat-card>

        <!-- Important Note -->
        <div class="alert alert-success">
          <mat-icon class="align-middle me-2">verified</mat-icon>
          <small>After payment, you will receive an M-Pesa confirmation SMS. Please keep it for your records.</small>
        </div>
      </div>

      <div class="text-center mt-4">
          <button
            mat-raised-button
            color="primary"
            class="px-5 py-2"
            type="button"
            (click)="goToSuccess()"
          >
            <mat-icon class="me-2">check_circle</mat-icon>
            I've Completed Payment
          </button>
        </div>

    } @else {
      <form [formGroup]="payForm" (ngSubmit)="pay()" class="mt-4">
        <div class="row g-3">
          <!-- Plan Selection -->
          <div class="col-12">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Select Plan</mat-label>
              <mat-select formControlName="plan">
                <mat-option value="emergency">Emergency services – KES 500</mat-option>
                <mat-option value="day-burg">Day-burg services – KES 2500</mat-option>
                <mat-option value="live-in">Live in Service – KES 2500</mat-option>
              </mat-select>
            </mat-form-field>
          </div>


          <!-- Location Surcharge Alert -->
          @if(!houseHelpIsInNairobi){
            <div class="col-12">
              <mat-card class="location-surcharge-card">
                <mat-card-content class="d-flex align-items-center gap-3">
                  <mat-icon class="text-warning">info</mat-icon>
                  <div>
                    <strong>Outside Nairobi Surcharge</strong>
                    <p class="mb-0 text-muted small">
                      An additional KES {{houseHelpCountySurcharge}} transport fee applies for hires from {{houseHelpCurrentCounty}} county.
                    </p>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          }

          <!-- Amount Breakdown -->
          @if(payForm.get('plan')?.value){
            <div class="col-12">
              <mat-card class="amount-breakdown-card">
                <mat-card-content>
                  <h6 class="mb-3 fw-bold">Payment Summary</h6>
                  
                  <div class="breakdown-row">
                    <span>Service Fee:</span>
                    <span class="fw-bold"> KES {{ getBasePlanAmount() | number }}</span>
                  </div>

                  @if(!houseHelpIsInNairobi){
                  <div class="breakdown-row">
                    <span>Transport Fee from {{houseHelpLocation}}, {{houseHelpCurrentCounty}}:</span>
                    <span class="fw-bold text-warning"> + KES {{ houseHelpCountySurcharge | number }}</span>
                  </div>
                }

                <mat-divider class="my-2"></mat-divider>

                <div class="breakdown-row total">
                    <span>Total Amount:</span>
                    <span class="fw-bold text-primary fs-5">KES {{ getTotalAmount() | number }}</span>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          }

          <!-- Mpesa Number -->
          <div class="col-12">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Mpesa Number</mat-label>
              <input matInput formControlName="phone" placeholder="0712345678 or +254712345678" />
              <mat-error *ngIf="payForm.get('phone')?.hasError('required')">
                Phone number is required
              </mat-error>
              <mat-error *ngIf="payForm.get('phone')?.hasError('pattern')">
                Invalid phone number format
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Submit Button -->
          <div class="col-12 text-center">
            <button
              mat-raised-button
              color="primary"
              class="px-4"
              type="submit"
              [disabled]="payForm.invalid || isProcessing"
            >
              Pay KES {{ getTotalAmount() | number }} & Proceed
            </button>
          </div>
        </div>
      </form>
    }
  </mat-card>
</div>
